<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cart | TechNova Store</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header></header>
  <nav>
    <a href="index.html">Home</a>
    <a href="products.html">Products</a>
    <a href="cart.html">Cart</a>
    <a href="account.html" id="accountLink" style="display:none;">Account</a>
    <a href="login.html" id="loginLink">Login</a>
    <a href="register.html" id="registerLink">Register</a>
    <a href="#" id="logoutLink" style="display:none;">Logout</a>
  </nav>
  <main>
    <h2>Your Cart</h2>
    <div id="cartContents"></div>
    <div id="cartMessage" style="text-align:center;margin:1rem;"></div>
  </main>
  <footer>Â© 2025 TechNova Store</footer>
  <script>
    function updateMenu() {
      const username = localStorage.getItem('username');
      if (username) {
        document.getElementById('accountLink').style.display = 'inline';
        document.getElementById('logoutLink').style.display = 'inline';
        document.getElementById('loginLink').style.display = 'none';
        document.getElementById('registerLink').style.display = 'none';
      } else {
        document.getElementById('accountLink').style.display = 'none';
        document.getElementById('logoutLink').style.display = 'none';
        document.getElementById('loginLink').style.display = 'inline';
        document.getElementById('registerLink').style.display = 'inline';
      }
    }
    updateMenu();
    document.getElementById('logoutLink').onclick = function() {
      localStorage.clear();
      window.location.href = 'index.html';
    };

    function renderCart() {
      const cartDiv = document.getElementById('cartContents');
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      let username = localStorage.getItem('username');
      let userId = localStorage.getItem('userId');
      if (!cart.length) {
        cartDiv.innerHTML = '<p>Your cart is empty.</p>';
        document.getElementById('cartMessage').textContent = '';
        return;
      }
      let total = 0;
      cartDiv.innerHTML = `
        <table style="width:100%;text-align:left;">
          <tr>
            <th>Product</th><th>Price</th><th>Qty</th><th>Update</th><th>Remove</th>
          </tr>
          ${cart.map((item, i) => {
            total += item.price * item.quantity;
            return `
              <tr>
                <td>${item.name}</td>
                <td>${item.price} USD</td>
                <td>
                  <input type="number" min="1" max="${item.stock_quantity}" value="${item.quantity}" id="qty-${i}" style="width:50px;">
                  <small>of ${item.stock_quantity} in stock</small>
                </td>
                <td>
                  <button onclick="updateQuantity(${i})">Save</button>
                </td>
                <td>
                  <button onclick="removeFromCart(${i})">Remove</button>
                </td>
              </tr>
            `;
          }).join('')}
        </table>
        <p style="text-align:right;"><strong>Total:</strong> ${total.toFixed(2)} USD</p>
        <button onclick="clearCart()">Clear Cart</button>
        ${username && userId ? '<button onclick="placeOrder()" style="margin-left:1rem;">Place Order</button>' : '<div style="margin-top:1rem;color:#f00;">You must log in to place an order.</div>'}
      `;
    }
    function removeFromCart(idx) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      cart.splice(idx, 1);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }
    function clearCart() {
      localStorage.removeItem('cart');
      renderCart();
    }
    function updateQuantity(idx) {
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      const qtyInput = document.getElementById('qty-' + idx);
      const qty = parseInt(qtyInput.value, 10);
      if (qty > 0 && qty <= cart[idx].stock_quantity) {
        cart[idx].quantity = qty;
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
      } else {
        alert('Not enough in stock!');
        qtyInput.value = cart[idx].stock_quantity;
      }
    }
    async function placeOrder() {
      let userId = localStorage.getItem('userId');
      let cart = JSON.parse(localStorage.getItem('cart')) || [];
      if (!userId) {
        alert('You must log in to place an order.');
        window.location.href = 'login.html';
        return;
      }
      if (!cart.length) {
        alert('Your cart is empty.');
        return;
      }
      try {
        const res = await fetch('http://localhost:3000/place-order', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ userId, items: cart })
        });
        const data = await res.json();
        if (res.ok) {
          localStorage.removeItem('cart');
          renderCart();
          document.getElementById('cartMessage').style.color = 'green';
          document.getElementById('cartMessage').textContent = 'Order placed successfully!';
        } else {
          document.getElementById('cartMessage').style.color = 'red';
          document.getElementById('cartMessage').textContent = data.message || 'Order failed.';
        }
      } catch (err) {
        document.getElementById('cartMessage').style.color = 'red';
        document.getElementById('cartMessage').textContent = 'Error placing order.';
      }
    }
    renderCart();
    window.removeFromCart = removeFromCart;
    window.clearCart = clearCart;
    window.updateQuantity = updateQuantity;
    window.placeOrder = placeOrder;
  </script>
</body>
</html>